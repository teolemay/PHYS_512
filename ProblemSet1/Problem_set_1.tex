\documentclass{article}

%opening
\title{PHYS 512 Problem set 1}
\author{Teophile Lemay, 281081252}
\date{}
\usepackage[left=2cm, right=2cm, top=2cm, bottom=2cm]{geometry}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{physics}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\newcommand{\<}[1]{\left\langle #1 \right\rangle }


\begin{document}
	\maketitle
	
\section{}
Given a function $f$, evaluated at the points $x\pm\delta$ and $x\pm2\delta$.

\subsection{a)}
The derivative at $x$ can be calculated from the points around $x$ using the central derivative formula (in the limit of small $\delta$):
\[f'(x) = \frac{f(x+\delta) - f(x-\delta)}{2\delta}\]
Performing a Taylor expansion of $f$ at each point gives
\[f(x+\delta) \approx f(x) + f'(x)\delta + \frac{1}{2}f''(x)\delta^2 + \frac{1}{6}f'''(x)\delta^3 + \frac{1}{24}f''''(x)\delta^4 + \frac{1}{120}f'''''(x)\delta^5 + ...\]
\[f(x-\delta) \approx f(x) - f'(x)\delta + \frac{1}{2}f''(x)\delta^2 - \frac{1}{6}f'''(x)\delta^3 + \frac{1}{24}f''''(x)\delta^4 - \frac{1}{120}f'''''(x)\delta^5 + ...\]
\[f(x+2\delta) \approx f(x) + f'(x)2\delta + 2f''(x)\delta^2 + \frac{4}{3}f'''(x)\delta^3 + \frac{2}{3}f''''(x)\delta^4 + \frac{4}{15}f'''''(x)\delta^5 + ...\]
\[f(x-2\delta) \approx f(x) - f'(x)2\delta + 2f''(x)\delta^2 - \frac{4}{3}f'''(x)\delta^3 + \frac{2}{3}f''''(x)\delta^4 - \frac{4}{15}f'''''(x)\delta^5 + ...\]
For the $x\pm\delta$ case, subtracting $f(x-\delta)$ from $f(x+\delta)$ gives the central derivative:
\[f(x+\delta) - f(x-\delta) = 2f'(x)\delta +\frac{1}{3}f'''(x)\delta^3 + \frac{1}{60}f'''''(x)\delta^5 + ...\]
\[f'(x) = \frac{f(x+\delta) - f(x-\delta)}{2\delta}-  \frac{1}{6}f'''(x)\delta^2 - \frac{1}{120}f'''''(x)\delta^4 + ... \]
Performing the same operation on the $x\pm2\delta$ case:
\[f'(x) = \frac{f(x+2\delta) - f(x-2\delta)}{4\delta} - \frac{2}{3}f'''(x)\delta^2 - \frac{2}{15}f'''''(x)\delta^4 - ...\]
The $\delta^2$ term can be eliminated by subtracting four times the $x\pm\delta$ derivative from the $x\pm2\delta$ derivative
\begin{multline*}
	f'(x) - 4f'(x) = \left(\frac{f(x+2\delta) - f(x-2\delta)}{4\delta} - \frac{2}{3}f'''(x)\delta^2 - \frac{2}{15}f'''''(x)\delta^4 - ...\right) - \\
	4\left(\frac{f(x+\delta) - f(x-\delta)}{2\delta}-  \frac{1}{6}f'''(x)\delta^2 - \frac{1}{120}f'''''(x)\delta^4 + ...\right)
\end{multline*}
\[-3f'(x) = \frac{8f(x-\delta) + f(x+2\delta) - 8f(x+\delta) - f(x-\delta)}{4\delta} - \frac{1}{10}f'''''(x)\delta^4\]
\[\boxed{ f'(x) = \frac{8f(x+\delta) - 8f(x-\delta) + f(x-\delta) - f(x+2\delta)}{12\delta} + \frac{1}{30}f'''''(x)\delta^4 + ... }\]

\subsection{b)}
The error for this derivative is comes from rounding error and discarding higher order terms from the Taylor series. For rounding error $\epsilon$, the error is approximately 
\[\text{error } = \frac{|f(x)|\cdot\epsilon}{\delta} + \frac{1}{30}f'''''(x)\delta^4 \text{.}\]
Minimizing with respect to $\delta$:
\[0 = \dv{}{\delta}\left( \frac{|f(x)|\cdot\epsilon}{\delta} + \frac{1}{30}f'''''(x)\delta^4 \right) = -\frac{|f(x)|\cdot \epsilon}{\delta^2} + \frac{2}{15}f'''''(x)\delta^3\]
\[\frac{|f(x)|\cdot \epsilon}{\delta^2} = \frac{2}{15}f'''''(x)\delta^3\]
\[\delta^5 = \frac{15}{2}\frac{|f(x)|\cdot \epsilon}{f'''''(x)}\]
So the ideal value of $\delta$ should be 
\[\boxed{ \delta = \left(\frac{15}{2}\frac{|f(x)|\cdot \epsilon}{f'''''(x)}\right)^{1/5} }\text{ .}\]
For $f = e^{x}$, the ideal step should be approximately
\[\delta \approx \left(\frac{15}{2}\frac{e^x}{e^x}\cdot10^{-16}\right)^{1/5} = \left(\frac{15}{2}\cdot10^{-16}\right)^{1/5} =  9.441\cdot10^{-4} \]
As shown in figure 1, the calculated value of $\delta$ performs better than steps sizes of an order of magnitude higher and lower.
\begin{figure}[h]
	\caption{Step size error comparison $f(x) = e^x$}
	\centering
	\includegraphics[scale=0.5]{Q1b1}
	\includegraphics[scale=0.5]{Q1b2}
\end{figure}
\\
For $f(x) = e^{0.01x}$, the ideal step size should be approximately
\[\delta \approx \left(\frac{15}{2}\frac{e^{0.01x}}{10^{-10}e^{0.01x}}\cdot 10^{-16} \right)^{1/5} = \left(\frac{15}{2} \cdot 10^{-6} \right)^{1/5} = 9.441\cdot 10^{-2} \]
As shown in Figure 2, this is also approximately the correct step size as it outperforms steps sizes of an order of magnitude larger and smaller.
\begin{figure}[h]
	\caption{Step size error comparison $f(x) = e^{0.01x}$}
	\centering
	\includegraphics[scale=0.5]{Q1b3}
	\includegraphics[scale=0.5]{Q1b4}
\end{figure}

\newpage
\section{}
\textbf{My numerical differentiator function pseudocode:}\\
Finding optimal step size $dx$:
\begin{itemize}
	\item To get around the proper order of magnitude, evaluate the derivative for $dx \in \{10^{-16}, 10^{-15}, 10^{-14}, ..., 10^{-1}, 1 \}$.
	\item Since I expect less variation near the optimal $dx$, evaluate differences of derivatives for adjacent $dx$ values and choose $dx$ corresponding to smallest difference.
	\item Refine the optimal $dx$ guess by repeating the previous steps above with $dx$ from the interval centered around the best guess $\{dx\cdot10^-1, ... dx, ... dx\cdot10\}$. I take the best $dx$ at this point as good enough to proceed.
	\begin{itemize}
		\item For array inputs of $x$ , the derivative is evaluated at all points of $x$ with all values of $dx$. Differences between derivatives for adjacent $dx$ values are calculated, then summed along each value of $x$ to get an array of the differences for each $dx$. The best $dx$ is chosen in the same manner, from the  $dx$ corresponding to the minimum difference.
	\end{itemize}
\end{itemize}
Evaluating the derivative:
\begin{itemize}
	\item The numerical derivative output is calculated using the central derivative.formula using the chosen best $dx$ at each point in $x$.
\end{itemize}
Estimating Error
\begin{itemize}
	\item Error estimation is calculated according to the formula for the error of the central derivative: $R \approx \frac{f(x)\epsilon}{dx} + \frac{1}{6}f'''(x)dx^2$ where $\epsilon = 10^{-16}$ is the rounding error.
	\begin{itemize}
		\item The third derivative for the error formula is crudely calculated at each point of the function:
		\item For each point in $x$, I calculate $f'(x\pm2dx)$ and use these values to get $f''(x+dx) = \frac{f'(x+2dx) - f'(x)}{2dx}$ and $f''(x-dx) = \frac{f'(x) - f'(x-2dx)}{2dx}$. Finally, the value of $f'''(x) = \frac{f''(x+dx) - f''(x-dx)}{2dx}$ is used to evaluate the formula for $R$.
	\end{itemize}
\end{itemize}
The code for this question is in the file named "Q2\_numerical\_differentiator.py". Testing on the function $f(x) = e^x$ results in actual error of order $10^{-11}$ or lower. The error estimated by the function is within one order of magnitude to the actual error and generally on the same order of magnitude or even closer.








\end{document}
